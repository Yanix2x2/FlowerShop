{% load static %}
<section id="orderStep">
    <div class="container">
        <div class="order orderStep">
            <div class="order__block">
                <div class="order_items">
                    <div class="title">Оплата</div>
                    <div class="order__form orderStep_form">
                        <div class="order__form_btns ficb">
                            <button type="button" class="btn order__form_pay">Оплатить</button>
                            <button class="btn order__form_btn">Назад</button>
                        </div>
                    </div>
                </div>
                <!-- <div class="blockImgHiden"></div> -->
            </div>
        </div>
    </div>
    <img src="img/orderImg.jpg" alt="orderImg" class="order__img">
</section>
<script src="https://widget.cloudpayments.ru/bundles/cloudpayments"></script>
<script>
(function () {
    var payBtn = document.querySelector('.order__form_pay');
    if (!payBtn) { return; }

    function normalizeAmount(s) {
        s = String(s).replace(/\s/g, '').replace(',', '.');
        var n = Number(s);
        return Number.isFinite(n) ? n : null;
    }

    payBtn.addEventListener('click', function (e) {
        e.preventDefault();
        if (!window.cp || !cp.CloudPayments) {
            alert('Не удалось загрузить виджет CloudPayments. Проверьте блокировщики и CSP.');
            return;
        }

        var amount = normalizeAmount("{{ amount }}") ?? 10.00;
        var widget = new cp.CloudPayments();
        try {
            widget.pay('auth', {
                publicId: "{{ PUBLIC_ID|default:'test_api_00000000000000000000001' }}",
                description: "Оплата букета #{{ bouquet_id }} (демо)",
                amount: amount,
                currency: "RUB",
                accountId: "demo-user@example.com",
                invoiceId: "order-{{ order_id|default:'demo' }}",
                skin: "mini"
            }, function () {
                const q = new URLSearchParams({order_id: "{{ order_id|default:'' }}"}).toString();
                window.location.href = "{% url 'payments:success' %}" + (q ? ("?"+q) : "");
            }, function () {
                window.location.href = "{% url 'payments:fail' %}";
            });
        } catch (err) {
            alert('Ошибка запуска виджета CloudPayments: ' + err.message);
        }
    });
})();
</script>